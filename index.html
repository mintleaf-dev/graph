<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Летний график</title>
    <script>
    // Регистрация Service Worker для push-уведомлений
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').then(function(reg) {
            console.log('Service Worker зарегистрирован:', reg.scope);
        }).catch(function(err) {
            console.warn('Service Worker не зарегистрирован:', err);
        });
    }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --accent: #f43f5e;
            --light: #f9fafb;
            --dark: #1f2937;
            --training: #ef4444;
            --free: #10b981;
            --walk: #8b5cf6;
            --study: #3b82f6;
            --rest: #84cc16;
            --food: #f59e0b;
            --other: #64748b;
            --cell-bg: #fff;
            --cell-text: #222;
            --row-bg: #f3f4f6;
            --row-hover: #e5e7eb;
            --category-study-bg: #e3edfc;
            --category-training-bg: #fde2e2;
            --category-rest-bg: #f3fbe3;
            --category-food-bg: #fff6e3;
            --category-other-bg: #e5e9f2;
        }
        body.dark {
            --primary: #818cf8;
            --primary-light: #a5b4fc;
            --secondary: #34d399;
            --accent: #fb7185;
            --light: #e0e0e0;
            --dark: #121212;
            --training: #ff6b6b;
            --free: #34d399;
            --walk: #a78bfa;
            --study: #60a5fa;
            --rest: #bef264;
            --food: #fbbf24;
            --other: #94a3b8;
            --cell-bg: #1e1e1e;
            --cell-text: #e0e0e0;
            --row-bg: #181818;
            --row-hover: #333333;
            --category-study-bg: #22304a;
            --category-training-bg: #3a2323;
            --category-rest-bg: #2a3320;
            --category-food-bg: #3a2f1e;
            --category-other-bg: #232a33;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--dark);
            color: var(--cell-text);
        }
        body.light {
            background-color: var(--light);
            color: var(--dark);
        }
        body.dark {
            background-color: var(--dark);
            color: var(--light);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            background: var(--cell-bg);
            color: var(--cell-text);
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            transition: background 0.3s, color 0.3s;
        }
        tbody tr {
            background: var(--row-bg);
            transition: background 0.3s;
        }
        tbody tr:hover {
            background: var(--row-hover);
        }
        .category-study td, .category-study {
            background: var(--category-study-bg) !important;
        }
        .category-training td, .category-training {
            background: var(--category-training-bg) !important;
        }
        .category-rest td, .category-rest {
            background: var(--category-rest-bg) !important;
        }
        .category-food td, .category-food {
            background: var(--category-food-bg) !important;
        }
        .category-other td, .category-other {
            background: var(--category-other-bg) !important;
        }
        .current-time {
            background-color: rgba(79, 70, 229, 0.2) !important;
            position: relative;
        }
        .current-time::after {
            content: "⏰ Сейчас";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .day-type-training {
            border-top: 4px solid var(--training);
        }
        .day-type-free {
            border-top: 4px solid var(--free);
        }
        .day-type-walk {
            border-top: 4px solid var(--walk);
        }
        /* Цветовые метки категорий */
        .category-dot-study { background: var(--study); }
        .category-dot-training { background: var(--training); }
        .category-dot-rest { background: var(--rest); }
        .category-dot-food { background: var(--food); }
        .category-dot-other { background: var(--other); }
        /* Цвет текста для категорий */
        .text-study { color: var(--study) !important; }
        .text-training { color: var(--training) !important; }
        .text-rest { color: var(--rest) !important; }
        .text-food { color: var(--food) !important; }
        .text-other { color: var(--other) !important; }
        /* Цвет текста для типов дней */
        .text-day-training { color: var(--training) !important; }
        .text-day-free { color: var(--free) !important; }
        .text-day-walk { color: var(--walk) !important; }
        /* Стилизация select для тёмной темы */
        select {
            background: var(--cell-bg);
            color: var(--cell-text);
            border: 1px solid #d1d5db;
            transition: background 0.3s, color 0.3s, border 0.3s;
        }
        body.dark select {
            color: #fff !important;
            border: 1px solid #444 !important;
            background: #1e1e1e !important;
        }
        body.dark select:focus {
            border-color: #666 !important;
        }
        /* Цветные option в select (только для поддерживающих браузеров) */
        select option.text-study { color: var(--study); }
        select option.text-training { color: var(--training); }
        select option.text-rest { color: var(--rest); }
        select option.text-food { color: var(--food); }
        select option.text-other { color: var(--other); }
        select option.text-day-training { color: var(--training); }
        select option.text-day-free { color: var(--free); }
        select option.text-day-walk { color: var(--walk); }
        /* Легенда категорий и типов дней — фон как у строк таблицы */
        .legend-dark-bg {
            background: #181818;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        @media (prefers-color-scheme: dark) {
            .legend-dark-bg { background: #181818; }
        }
        body.dark .legend-dark-bg { background: #181818; }
        /* Для day-type-selector */
        select option.text-day-training { color: var(--training); }
        select option.text-day-free { color: var(--free); }
        select option.text-day-walk { color: var(--walk); }
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white !important;
                color: black !important;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* --- ДОБАВЛЕНО: стили для новых кнопок действий --- */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
            cursor: pointer;
        }
        .action-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-duplicate {
            background: #e0e7ef;
            color: #22c55e;
        }
        .btn-duplicate:hover {
            background: #86efac;
            color: #166534;
        }
        .btn-reminder {
            background: #e5e7eb;
            color: #6b7280;
        }
        .btn-reminder.active {
            background: #fbbf24;
            color: #fff;
        }
        .btn-reminder:hover {
            background: #fde68a;
            color: #b45309;
        }
        .dark .btn-duplicate {
            background: #232a33;
            color: #4ade80;
        }
        .dark .btn-duplicate:hover {
            background: #13b020;
            color: #166534;
        }
        .dark .btn-reminder {
            background: #232a33;
            color: #6b7280;
        }
        .dark .btn-reminder.active {
            background: #fbbf24;
            color: #222;
        }
        .dark .btn-reminder:hover {
            background: #fde68a;
            color: #b45309;
        }
    </style>
</head>
<body class="light">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <button id="push-subscribe-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg no-print" style="margin-bottom:10px;">
                Включить push-уведомления
            </button>
            
        <script>
        // === VAPID public key (замените на свой после генерации!) ===
        const VAPID_PUBLIC_KEY = 'BIQ5PVV-TXsTlnXI1IthlAALnsmXyQSnqJ6BHa3vzvmSmdZNOHzeN4r-QqfVOex06OfRlk3VVcIuGZN8sGv8IdQ';

        // Функция для подписки на push-уведомления
        async function subscribeUserToPush() {
            if (!('serviceWorker' in navigator)) {
                alert('Service Worker не поддерживается');
                return;
            }
            const reg = await navigator.serviceWorker.ready;
            let subscription = await reg.pushManager.getSubscription();
            if (!subscription) {
                try {
                    subscription = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                } catch (e) {
                    alert('Не удалось подписаться: ' + e);
                    return;
                }
            }
            // Отправить подписку на сервер
            try {
                await fetch('/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription)
                });
                alert('Подписка на push-уведомления выполнена!');
            } catch (e) {
                alert('Ошибка отправки подписки на сервер: ' + e);
            }
        }

        // Вспомогательная функция для преобразования ключа
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
        }

        // Навесить обработчик на кнопку
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('push-subscribe-btn');
            if (btn) btn.onclick = subscribeUserToPush;
        });
        </script>

            <h1 class="text-3xl font-bold text-primary">Летний график</h1>
            
            <div class="flex flex-wrap gap-2">
                <button id="theme-toggle" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center gap-2 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors no-print">
                    <span id="theme-icon">🌙</span>
                    <span id="theme-text">Тёмная тема</span>
                </button>
                
                <button id="export-pdf" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center gap-2 hover:bg-blue-700 transition-colors no-print">
                    <span>📄</span>
                    <span>Экспорт PDF</span>
                </button>
                
                <button id="reset-schedule" class="px-4 py-2 bg-red-600 text-white rounded-lg flex items-center gap-2 hover:bg-red-700 transition-colors no-print">
                    <span>🔄</span>
                    <span>Сбросить</span>
                </button>
            </div>
        </div>

        <div class="mb-6 no-print">
            <div class="w-full h-5 bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden mb-2">
                <div id="progress-bar-fill" class="h-5 bg-primary transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center gap-2">
                <h2 class="text-lg font-semibold">Прогресс дня:</h2>
                <span id="progress-percentage" class="text-sm font-medium">0%</span>
            </div>
        </div>



        <div class="overflow-x-auto">
            <div class="mb-4 no-print">
                <select id="day-type-selector" class="px-4 py-2 border rounded-lg">
                    <option value="all" class="text-primary">Все дни</option>
                    <option value="training" class="text-day-training">День с тренировкой</option>
                    <option value="free" class="text-day-free">Свободный день</option>
                    <option value="walk" class="text-day-walk">День с прогулкой</option>
                </select>
                <button id="add-row" class="ml-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    + Добавить строку
                </button>
            </div>
            <div id="tables-container"></div>
        </div>

        <!-- Модальное окно для заметок -->
        <div id="notes-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold mb-4">Заметки</h3>
                <textarea id="notes-content" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none h-24" placeholder="Введите ваши заметки здесь..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="notes-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Сохранить
                    </button>
                    <button id="notes-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scheduleData = {};
        let currentDayType = 'training';
        let currentNoteRowId = null;
        let notificationsEnabled = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadScheduleData();
            setupEventListeners();
            updateDayProgress();
            highlightCurrentTime();
            // Обновление времени каждую минуту + проверка напоминаний
            setInterval(() => {
                highlightCurrentTime();
                updateDayProgress();
                checkUpcomingActivities();
            }, 60000);
            // Запрос разрешения на уведомления
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationsEnabled = permission === 'granted';
                });
            }
            // Проверка напоминаний сразу при загрузке
            checkUpcomingActivities();
        });

        // Загрузка данных из localStorage или использование шаблонов
        function loadScheduleData() {
            const savedData = localStorage.getItem('scheduleData');
            
            if (savedData) {
                scheduleData = JSON.parse(savedData);
            } else {
                // Инициализация шаблонными данными
                scheduleData = getTemplateData();
            }
            
            renderSchedule();
        }

        // Получение шаблонных данных для разных типов дней
        function getTemplateData() {
            return {
                'training': [
                    { id: 't1', time: '6:00-6:30', activity: 'Подъём, зарядка', category: 'other', notes: '' },
                    { id: 't2', time: '6:30-7:30', activity: 'Украинский язык (теория/тесты)', category: 'study', notes: '' },
                    { id: 't3', time: '7:30-8:30', activity: 'История Украины (теория/тесты)', category: 'study', notes: '' },
                    { id: 't4', time: '8:30-9:00', activity: 'Завтрак', category: 'food', notes: '' },
                    { id: 't5', time: '9:00-10:30', activity: 'Математика (разбор заданий)', category: 'study', notes: '' },
                    { id: 't6', time: '10:30-12:00', activity: 'Украинская литература (чтение/разбор)', category: 'study', notes: '' },
                    { id: 't7', time: '12:00-13:00', activity: 'Отдых, обед', category: 'food', notes: '' },
                    { id: 't8', time: '13:00-14:00', activity: 'Повторение/английский язык', category: 'study', notes: '' },
                    { id: 't9', time: '14:00-16:30', activity: 'Сборы и дорога в зал', category: 'other', notes: '' },
                    { id: 't10', time: '16:30-20:00', activity: 'Тренировка', category: 'training', notes: '' },
                    { id: 't11', time: '20:00-21:00', activity: 'Ужин, душ', category: 'food', notes: '' },
                    { id: 't12', time: '21:00-22:00', activity: 'Отдых, подготовка ко сну', category: 'rest', notes: '' },
                    { id: 't13', time: '22:00', activity: 'Сон', category: 'rest', notes: '' }
                ],
                'free': [
                    { id: 'f1', time: '6:00-6:30', activity: 'Подъём, зарядка', category: 'other', notes: '' },
                    { id: 'f2', time: '6:30-7:30', activity: 'Украинский язык (теория/тесты)', category: 'study', notes: '' },
                    { id: 'f3', time: '7:30-8:30', activity: 'История Украины (теория/тесты)', category: 'study', notes: '' },
                    { id: 'f4', time: '8:30-9:00', activity: 'Завтрак', category: 'food', notes: '' },
                    { id: 'f5', time: '9:00-10:30', activity: 'Математика (разбор заданий)', category: 'study', notes: '' },
                    { id: 'f6', time: '10:30-12:00', activity: 'Украинская литература (чтение/разбор)', category: 'study', notes: '' },
                    { id: 'f7', time: '12:00-13:00', activity: 'Отдых, обед', category: 'food', notes: '' },
                    { id: 'f8', time: '13:00-15:00', activity: 'Программирование (курсы, проекты)', category: 'study', notes: '' },
                    { id: 'f9', time: '15:00-16:30', activity: 'Английский язык (грамматика/практика)', category: 'study', notes: '' },
                    { id: 'f10', time: '16:30-18:00', activity: 'Повторение, упражнения', category: 'study', notes: '' },
                    { id: 'f11', time: '18:00-19:00', activity: 'Свободное время (хобби, отдых)', category: 'rest', notes: '' },
                    { id: 'f12', time: '19:00-20:00', activity: 'Ужин', category: 'food', notes: '' },
                    { id: 'f13', time: '20:00-21:00', activity: 'Подготовка ко сну', category: 'rest', notes: '' },
                    { id: 'f14', time: '21:00-22:00', activity: 'Отдых', category: 'rest', notes: '' },
                    { id: 'f15', time: '22:00', activity: 'Сон', category: 'rest', notes: '' }
                ],
                'walk': [
                    { id: 'w1', time: '6:00-6:30', activity: 'Подъём, зарядка', category: 'other', notes: '' },
                    { id: 'w2', time: '6:30-7:30', activity: 'Украинский язык (теория/тесты)', category: 'study', notes: '' },
                    { id: 'w3', time: '7:30-8:30', activity: 'История Украины (теория/тесты)', category: 'study', notes: '' },
                    { id: 'w4', time: '8:30-9:00', activity: 'Завтрак', category: 'food', notes: '' },
                    { id: 'w5', time: '9:00-10:30', activity: 'Математика (разбор заданий)', category: 'study', notes: '' },
                    { id: 'w6', time: '10:30-12:00', activity: 'Украинская литература (чтение/разбор)', category: 'study', notes: '' },
                    { id: 'w7', time: '12:00-13:00', activity: 'Отдых, обед', category: 'food', notes: '' },
                    { id: 'w8', time: '13:00-14:00', activity: 'Английский язык или программирование', category: 'study', notes: '' },
                    { id: 'w9', time: '14:00-20:00', activity: 'Прогулка/время с парнем', category: 'rest', notes: '' },
                    { id: 'w10', time: '20:00-21:00', activity: 'Ужин, душ', category: 'food', notes: '' },
                    { id: 'w11', time: '21:00-22:00', activity: 'Отдых', category: 'rest', notes: '' },
                    { id: 'w12', time: '22:00', activity: 'Сон', category: 'rest', notes: '' }
                ]
            };
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Переключение типа дня
            document.getElementById('day-type-selector').addEventListener('change', (e) => {
                currentDayType = e.target.value;
                renderSchedule();
            });
            
            // Добавление новой строки
            document.getElementById('add-row').addEventListener('click', addNewRow);
            
            // Переключение темы
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Экспорт в PDF
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            
            // Сброс расписания
            document.getElementById('reset-schedule').addEventListener('click', resetSchedule);
            
            // Обработчики для модального окна заметок
            document.getElementById('notes-cancel').addEventListener('click', closeNotesModal);
            document.getElementById('notes-save').addEventListener('click', saveNotes);
        }

        // --- Новый универсальный рендерер для одной или всех таблиц ---
        function renderSchedule() {
            const selector = document.getElementById('day-type-selector');
            let mode = selector.value;
            if (!mode) mode = 'all';
            const container = document.getElementById('tables-container');
            container.innerHTML = '';

            // Для режима "Все дни"
            if (mode === 'all') {
                ['training', 'free', 'walk'].forEach(type => {
                    container.appendChild(renderScheduleTable(type, true));
                });
                document.getElementById('add-row').style.display = 'none';
            } else {
                container.appendChild(renderScheduleTable(mode, false));
                document.getElementById('add-row').style.display = '';
            }
        }

        // --- Рендеринг одной таблицы расписания ---
        function renderScheduleTable(dayType, showTitle) {
            const dayNames = {
                'training': 'День с тренировкой',
                'free': 'Полностью свободный день',
                'walk': 'День с прогулкой'
            };
            const tableWrap = document.createElement('div');
            tableWrap.className = 'mb-8';
            if (showTitle) {
                const h3 = document.createElement('h3');
                h3.className = 'text-xl font-bold mb-2';
                h3.textContent = dayNames[dayType] || '';
                tableWrap.appendChild(h3);
            }
            const table = document.createElement('table');
            table.className = `min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow day-type-${dayType}`;
            const thead = document.createElement('thead');
            thead.innerHTML = `<tr class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                <th class="py-3 px-3 text-left text-sm font-medium w-32" style="min-width:90px;max-width:120px;">Время</th>
                <th class="py-3 px-3 text-left text-sm font-medium w-32" style="min-width:100px;max-width:140px;">Длительность</th>
                <th class="py-3 px-4 text-left text-sm font-medium">Занятие</th>
                <th class="py-3 px-4 text-left text-sm font-medium">Категория</th>
                <th class="py-3 px-4 text-left text-sm font-medium no-print">Заметки</th>
                <th class="py-3 px-4 text-left text-sm font-medium no-print">Действия</th>
            </tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            tbody.className = 'text-sm font-normal text-gray-800 dark:text-gray-200';
            const dayData = scheduleData[dayType] || [];
            const reminders = getReminders();
            const currentRowId = getCurrentRowId(dayType);
            // Определяем, для какой таблицы и строки показывать ⏰
            let autoDayType = getAutoDayType();
            let selectorValue = document.getElementById('day-type-selector').value;


            // === БЛОК: расчёт длительности интервалов времени для каждой строки ===
            // Новый расчёт длительности для каждой строки
            function getDurationText(timeStr) {
                const timeRange = timeStr.split('-');
                if (timeRange.length === 2) {
                    const start = parseTime(timeRange[0]);
                    const end = parseTime(timeRange[1]);
                    if (start && end) {
                        let mins = (end.hour * 60 + end.minute) - (start.hour * 60 + start.minute);
                        if (mins < 0) mins += 24 * 60; // переход через полночь
                        if (mins > 0 && mins < 60) {
                            return `${mins} мин`;
                        } else if (mins >= 60) {
                            const hours = Math.floor(mins / 60);
                            const minutes = mins % 60;
                            if (minutes === 0) {
                                return `${hours} ${hours === 1 ? 'час' : (hours >= 2 && hours <= 4 ? 'часа' : 'часов')}`;
                            } else {
                                return `${hours} ${hours === 1 ? 'час' : (hours >= 2 && hours <= 4 ? 'часа' : 'часов')} ${minutes} мин`;
                            }
                        }
                    }
                }
                return '';
            }

            dayData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.dataset.id = item.id;
                row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700', 'transition-colors');
                if (item.category) {
                    row.classList.add(`category-${item.category}`);
                }
                // Логика отображения кнопки ⏰
                let showClockBtn = false;
                if (item.id === currentRowId) {
                    if (selectorValue === 'all') {
                        showClockBtn = (dayType === autoDayType);
                    } else {
                        showClockBtn = (dayType === autoDayType);
                    }
                    if (showClockBtn) row.classList.add('current-time');
                }
                // Новый вывод длительности
                row.innerHTML = `
                    <td class="border p-2 w-32" style="min-width:90px;max-width:120px;">
                        <input type="text" value="${item.time}" class="w-full bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500 py-1 text-sm" 
                            onchange="updateCell('${item.id}', 'time', this.value, '${dayType}')">
                    </td>
                    <td class="border p-2 w-32 text-center text-xs text-gray-700 dark:text-gray-300" style="min-width:100px;max-width:140px;">
                        ${getDurationText(item.time)}
                    </td>
                    <td class="border p-2">
                        <input type="text" value="${item.activity}" class="w-full bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500 py-1" 
                            onchange="updateCell('${item.id}', 'activity', this.value, '${dayType}')">
                    </td>
                    <td class="border p-2">
                        <select class="w-full bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500 py-1" 
                            onchange="updateCell('${item.id}', 'category', this.value, '${dayType}')">
                            <option value="study" class="text-study" ${item.category === 'study' ? 'selected' : ''}>Учёба</option>
                            <option value="training" class="text-training" ${item.category === 'training' ? 'selected' : ''}>Тренировка</option>
                            <option value="rest" class="text-rest" ${item.category === 'rest' ? 'selected' : ''}>Отдых</option>
                            <option value="food" class="text-food" ${item.category === 'food' ? 'selected' : ''}>Еда</option>
                            <option value="other" class="text-other" ${item.category === 'other' ? 'selected' : ''}>Другое</option>
                        </select>
                    </td>
                    <td class="border p-2 no-print">
                        <button class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
                            onclick="openNotesModal('${item.id}', '${dayType}')" title="Заметки">
                            ${item.notes ? '📝 Есть заметки' : '✏️ Добавить'}
                        </button>
                    </td>
                    <td class="border p-2 no-print">
                        <div class="flex gap-2">
                            <button class="action-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 handle" title="Переместить">
                                ↕️
                            </button>
                            <button class="action-btn p-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 hover:bg-red-200 dark:hover:bg-red-800" onclick="deleteRow('${item.id}', '${dayType}')" title="Удалить">
                                🗑️
                            </button>
                            <button class="action-btn btn-duplicate" onclick="duplicateRow('${item.id}', '${dayType}')" title="Дублировать">
                                ➕
                            </button>
                            <button class="action-btn btn-reminder${reminders[item.id] ? ' active' : ''}" onclick="toggleReminder('${item.id}')" title="Напоминание">
                                🔔
                            </button>
                            ${showClockBtn ? `<button class="action-btn btn-clock" title="Сейчас"></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            // Drag&drop только если не all
            if (document.getElementById('day-type-selector').value !== 'all') {
                new Sortable(tbody, {
                    handle: '.handle',
                    animation: 150,
                    onEnd: function(evt) {
                        updateRowOrder(dayType);
                    }
                });
            }
            tableWrap.appendChild(table);
            return tableWrap;
        }

        // Получить id строки с текущим временем для dayType
function getCurrentRowId(dayType) {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const dayData = scheduleData[dayType] || [];
    let lastBlockId = null;
    for (const item of dayData) {
        const timeRange = item.time.split('-');
        if (timeRange.length === 2) {
            const startTime = parseTime(timeRange[0]);
            const endTime = parseTime(timeRange[1]);
            if (startTime && endTime) {
                const currentTime = currentHour * 60 + currentMinute;
                const startMinutes = startTime.hour * 60 + startTime.minute;
                const endMinutes = endTime.hour * 60 + endTime.minute;
                if (currentTime >= startMinutes && currentTime < endMinutes) {
                    return item.id;
                }
            }
        } else if (timeRange.length === 1 && item.time.trim()) {
            // Если только время начала (например, "22:00"), считаем активным, если текущее время >= start
            const startTime = parseTime(timeRange[0]);
            if (startTime) {
                const currentTime = currentHour * 60 + currentMinute;
                const startMinutes = startTime.hour * 60 + startTime.minute;
                if (currentTime >= startMinutes) {
                    lastBlockId = item.id;
                }
            }
        }
    }
    return lastBlockId;
}


        // --- Универсальные функции для работы с dayType ---
        function updateCell(id, field, value, dayType) {
            dayType = dayType || getCurrentDayType();
            const dayData = scheduleData[dayType] || [];
            const itemIndex = dayData.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                dayData[itemIndex][field] = value;
                if (field === 'category') {
                    const selector = document.querySelector(`tr[data-id="${id}"]`);
                    if (selector) {
                        selector.className = selector.className.replace(/category-\w+/g, '');
                        selector.classList.add(`category-${value}`);
                    }
                }
                saveScheduleData();
                // После изменения времени или любой другой ячейки — всегда пересчитываем длительность через renderSchedule
                renderSchedule();
            }
        }

        function addNewRow(dayType) {
            dayType = dayType || getCurrentDayType();
            if (dayType === 'all') dayType = 'training';
            const dayData = scheduleData[dayType] || [];
            const newId = `${dayType[0]}${Date.now()}`;
            dayData.push({
                id: newId,
                time: '',
                activity: '',
                category: 'other',
                notes: ''
            });
            scheduleData[dayType] = dayData;
            renderSchedule();
        }

        function deleteRow(id, dayType) {
            dayType = dayType || getCurrentDayType();
            const dayData = scheduleData[dayType] || [];
            const itemIndex = dayData.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                dayData.splice(itemIndex, 1);
                scheduleData[dayType] = dayData;
                renderSchedule();
            }
        }

        function updateRowOrder(dayType) {
            dayType = dayType || getCurrentDayType();
            const container = document.getElementById('tables-container');
            const table = container.querySelector(`.day-type-${dayType}`);
            if (!table) return;
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const newOrder = [];
            const dayData = scheduleData[dayType] || [];
            rows.forEach(row => {
                const id = row.dataset.id;
                const item = dayData.find(item => item.id === id);
                if (item) newOrder.push(item);
            });
            scheduleData[dayType] = newOrder;
            saveScheduleData();
        }

        function duplicateRow(id, dayType) {
            dayType = dayType || getCurrentDayType();
            const dayData = scheduleData[dayType] || [];
            const idx = dayData.findIndex(item => item.id === id);
            if (idx !== -1) {
                const orig = dayData[idx];
                const copy = { ...orig, id: `${id}_copy_${Date.now()}` };
                dayData.splice(idx + 1, 0, copy);
                scheduleData[dayType] = dayData;
                renderSchedule();
            }
        }

        function openNotesModal(rowId, dayType) {
            currentNoteRowId = rowId;
            currentNoteDayType = dayType || getCurrentDayType();
            const dayData = scheduleData[currentNoteDayType] || [];
            const item = dayData.find(item => item.id === rowId);
            if (item) {
                document.getElementById('notes-content').value = item.notes || '';
                document.getElementById('notes-modal').classList.remove('hidden');
            }
        }

        function getCurrentDayType() {
            const selector = document.getElementById('day-type-selector');
            return selector && selector.value ? selector.value : 'all';
        }

        function highlightCurrentTime() {
            renderSchedule();
        }

        // Сохранение данных в localStorage
        function saveScheduleData() {
            localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
        }

        // (удалена дублирующая функция highlightCurrentTime)

        // Проверка предстоящих занятий для уведомлений (для всех дней и всех строк)
        function checkUpcomingActivities() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinute;
            const reminders = getReminders();
            // Проверяем все dayType
            ['training', 'free', 'walk'].forEach(dayType => {
                const dayData = scheduleData[dayType] || [];
                for (const item of dayData) {
                    if (!reminders[item.id]) continue; // Только для включённых напоминаний
                    const timeRange = item.time.split('-');
                    if (timeRange.length === 2) {
                        const startTime = parseTime(timeRange[0]);
                        if (startTime) {
                            const startMinutes = startTime.hour * 60 + startTime.minute;
                            const timeUntilStart = startMinutes - currentTime;
                            // Уведомление за 10 минут до начала
                            if (timeUntilStart > 0 && timeUntilStart <= 10) {
                                const notificationKey = `reminder_${item.id}_${now.toDateString()}`;
                                const notificationSent = localStorage.getItem(notificationKey);
                                if (!notificationSent && 'Notification' in window && Notification.permission === 'granted') {
                                    new Notification('Напоминание о расписании', {
                                        body: `Через ${timeUntilStart} мин: ${item.activity}`,
                                        icon: 'https://cdn-icons-png.flaticon.com/512/2693/2693507.png'
                                    });
                                    reminderAudio.play().catch(()=>{});
                                    localStorage.setItem(notificationKey, 'sent');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Парсинг времени из строки
        function parseTime(timeStr) {
            const match = timeStr.trim().match(/(\d{1,2}):?(\d{2})?/);
            
            if (match) {
                return {
                    hour: parseInt(match[1], 10),
                    minute: match[2] ? parseInt(match[2], 10) : 0
                };
            }
            
            return null;
        }

        // Обновление прогресса дня
        function updateDayProgress() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Считаем, что день начинается в 6:00 и заканчивается в 22:00
            const dayStartMinutes = 6 * 60;
            const dayEndMinutes = 22 * 60;
            const currentTimeMinutes = currentHour * 60 + currentMinute;
            
            let progress = 0;
            
            if (currentTimeMinutes < dayStartMinutes) {
                progress = 0;
            } else if (currentTimeMinutes > dayEndMinutes) {
                progress = 100;
            } else {
                progress = Math.floor(((currentTimeMinutes - dayStartMinutes) / (dayEndMinutes - dayStartMinutes)) * 100);
            }
            
            document.getElementById('progress-percentage').textContent = `${progress}%`;
            const fill = document.getElementById('progress-bar-fill');
            fill.style.width = `${progress}%`;
            fill.style.background = 'linear-gradient(90deg, #22c55e 0%, #16a34a 100%)';
            fill.style.transition = 'width 0.5s cubic-bezier(0.4,0,0.6,1)';
        }

        // ...existing code...

        // Закрытие модального окна для заметок
        function closeNotesModal() {
            document.getElementById('notes-modal').classList.add('hidden');
            currentNoteRowId = null;
        }

        // Сохранение заметок
        let currentNoteDayType = null;
        function saveNotes() {
            if (currentNoteRowId) {
                const notes = document.getElementById('notes-content').value;
                const dayType = currentNoteDayType || getCurrentDayType();
                const dayData = scheduleData[dayType] || [];
                const itemIndex = dayData.findIndex(item => item.id === currentNoteRowId);
                if (itemIndex !== -1) {
                    dayData[itemIndex].notes = notes;
                    saveScheduleData();
                    renderSchedule();
                }
                closeNotesModal();
            }
        }

        // Переключение темы
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (body.classList.contains('light')) {
                body.classList.remove('light');
                body.classList.add('dark');
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Светлая тема';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark');
                body.classList.add('light');
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Тёмная тема';
                localStorage.setItem('theme', 'light');
            }
        }

        // Экспорт в PDF
        function exportToPDF() {
            window.print();
        }

        // Сброс расписания
        function resetSchedule() {
            if (confirm('Вы уверены, что хотите сбросить расписание? Все ваши изменения будут потеряны.')) {
                localStorage.removeItem('scheduleData');
                scheduleData = getTemplateData();
                renderSchedule();
            }
        }

        // Загрузка сохраненной темы
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.remove('light');
            document.body.classList.add('dark');
            document.getElementById('theme-icon').textContent = '☀️';
            document.getElementById('theme-text').textContent = 'Светлая тема';
        }
        // --- ДОБАВЛЕНО: для звука уведомления ---
        const reminderAudio = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae1b2.mp3');
        // --- ДОБАВЛЕНО: напоминания для строк ---
        function getReminders() {
            return JSON.parse(localStorage.getItem('rowReminders') || '{}');
        }
        function setReminders(obj) {
            localStorage.setItem('rowReminders', JSON.stringify(obj));
        }
        function isReminderActive(rowId) {
            const rem = getReminders();
            return !!rem[rowId];
        }
        function toggleReminder(rowId) {
            const rem = getReminders();
            if (rem[rowId]) {
                delete rem[rowId];
            } else {
                rem[rowId] = true;
            }
            setReminders(rem);
            renderSchedule();
        }
        // ...existing code...
        // ...existing code...
        // ...existing code...
        // --- ДОБАВЛЕНО: сброс напоминаний при смене дня ---
        document.getElementById('day-type-selector').addEventListener('change', () => {
            // Сбросить отметки о сработавших напоминаниях для нового дня
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('reminder_')) localStorage.removeItem(key);
            });
            renderSchedule();
        });

        // --- Инициализация: по умолчанию режим "Все дни" ---
        // --- Автоматический выбор типа дня по циклу с 4 июля 2025 ---
        function getAutoDayType() {
            // 4 июля 2025 — первый день цикла (день с тренировкой)
            const cycle = ['training', 'free', 'training', 'walk'];
            const start = new Date(2025, 6, 4); // Месяцы с 0, июль = 6
            const now = new Date();
            // Обнуляем время для точного расчёта дней
            start.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            const daysPassed = Math.floor((now - start) / (1000 * 60 * 60 * 24));
            let idx = (daysPassed % 4);
            if (idx < 0) idx += 4;
            // Маппинг по условию
            // Остаток 0 или 4 → walk, 1 → training, 2 → free, 3 → training
            if (idx === 0) return 'training';
            if (idx === 1) return 'free';
            if (idx === 2) return 'training';
            if (idx === 3) return 'walk';
            return 'training';
        }

        window.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('day-type-selector');
            // Если пользователь не выбирал вручную, авто-режим
            let autoType = getAutoDayType();
            selector.value = autoType;
            renderSchedule();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'958fcdffc6db2d97',t:'MTc1MTQ3NjczMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
